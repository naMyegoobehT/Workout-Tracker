<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Tracker</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Libraries (UMD Global Build) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel to translate JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Removes number input spinners */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        .dragging {
            opacity: 0.5;
            background: #cce5ff;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <!-- Main application script -->
    <script type="text/babel" data-type="module">
        // Firebase SDKs are imported as modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // React is available globally from the script tags in the <head>
        const { useState, useEffect, useRef } = React;

        // --- Default Data ---
        const createDefaultProgram = () => ({
            id: `program_${Date.now()}`,
            name: 'Default Program',
            workouts: [
                {
                    id: `workout_${Date.now()}_a`,
                    name: 'Workout A',
                    exercises: [
                        { id: `ex_${Date.now()}_1`, name: 'Vertical Leg Press', sets: 5, reps: 5, progressionIncrement: 5, deloadFrequency: 3, deloadPercentage: 10, baseWeight: 45, startingWeight: 45, consecutiveFailures: 0 },
                        { id: `ex_${Date.now()}_2`, name: 'Machine Chest Press', sets: 5, reps: 5, progressionIncrement: 2.5, deloadFrequency: 3, deloadPercentage: 10, baseWeight: 45, startingWeight: 45, consecutiveFailures: 0 },
                        { id: `ex_${Date.now()}_3`, name: 'Seated Cable Row', sets: 5, reps: 5, progressionIncrement: 2.5, deloadFrequency: 3, deloadPercentage: 10, baseWeight: 45, startingWeight: 45, consecutiveFailures: 0 },
                    ]
                },
                {
                    id: `workout_${Date.now()}_b`,
                    name: 'Workout B',
                    exercises: [
                        { id: `ex_${Date.now()}_4`, name: 'Vertical Leg Press', sets: 5, reps: 5, progressionIncrement: 5, deloadFrequency: 3, deloadPercentage: 10, baseWeight: 45, startingWeight: 45, consecutiveFailures: 0 },
                        { id: `ex_${Date.now()}_5`, name: 'Machine Shoulder Press', sets: 5, reps: 5, progressionIncrement: 2.5, deloadFrequency: 3, deloadPercentage: 10, baseWeight: 45, startingWeight: 45, consecutiveFailures: 0 },
                        { id: `ex_${Date.now()}_6`, name: 'Hamstring Curls', sets: 3, reps: 8, progressionIncrement: 2.5, deloadFrequency: 3, deloadPercentage: 10, baseWeight: 45, startingWeight: 45, consecutiveFailures: 0 },
                    ]
                }
            ],
            currentWorkoutIndex: 0
        });

        const AuthPage = ({ auth }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSignUp = async () => {
                setLoading(true);
                setError('');
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleSignIn = async () => {
                setLoading(true);
                setError('');
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center">
                    <div className="bg-white p-8 rounded-xl shadow-md w-full max-w-md space-y-6">
                        <h2 className="text-3xl font-bold text-center text-gray-800">Workout Tracker</h2>
                        {error && <p className="bg-red-100 text-red-700 p-3 rounded-lg text-center">{error}</p>}
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Email</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
                                    placeholder="you@example.com"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Password</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
                                    placeholder="••••••••"
                                />
                            </div>
                        </div>
                        <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                            <button onClick={handleSignIn} disabled={loading} className="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition-colors disabled:bg-indigo-300">
                                {loading ? 'Signing In...' : 'Sign In'}
                            </button>
                            <button onClick={handleSignUp} disabled={loading} className="w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 transition-colors disabled:bg-green-300">
                                {loading ? 'Signing Up...' : 'Sign Up'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [appData, setAppData] = useState(null);
            const [currentPage, setCurrentPage] = useState('home');
            const [workoutProgress, setWorkoutProgress] = useState({});
            const [bodyweight, setBodyweight] = useState('');
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [firebase, setFirebase] = useState({ auth: null, db: null });

            useEffect(() => {
                try {
                    const firebaseConfig = {
                        apiKey: "AIzaSyDlr6sZB06BKRYEd1fnYuM_h0icAzmrOkg",
                        authDomain: "workout-program-f681e.firebaseapp.com",
                        projectId: "workout-program-f681e",
                        storageBucket: "workout-program-f681e.firebasestorage.app",
                        messagingSenderId: "953988180606",
                        appId: "1:953988180606:web:f26f8124f59c0b39cec62f"
                    };
                    
                    if (firebaseConfig.apiKey.startsWith("YOUR_")) {
                        setError("Firebase configuration is missing.");
                        setLoading(false);
                        return;
                    }

                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    setFirebase({ auth, db });
                    setLogLevel('debug');

                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        setUser(user);
                        if (!user) setLoading(false);
                    });
                    return () => unsubscribe();
                } catch (e) {
                    console.error("Firebase Init Error:", e);
                    setError("Failed to initialize the application.");
                    setLoading(false);
                }
            }, []);

            useEffect(() => {
                if (!user || !firebase.db) {
                    if (user === null) setLoading(false);
                    return;
                }

                setLoading(true);
                const docRef = doc(firebase.db, `users/${user.uid}/workoutData`, "data");

                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        let data = docSnap.data();
                        
                        // --- One-Time Data Migration ---
                        if (data.program && !data.programs) {
                            console.log("Migrating old data structure...");
                            const legacyProgram = createDefaultProgram();
                            legacyProgram.name = "My Legacy Program";
                            legacyProgram.workouts[0].exercises = data.program.workoutA.exercises.map((ex, i) => ({...ex, id: `ex_${Date.now()}_${i}`}));
                            legacyProgram.workouts[1].exercises = data.program.workoutB.exercises.map((ex, i) => ({...ex, id: `ex_${Date.now()}_b_${i}`}));
                            
                            const newData = {
                                programs: [legacyProgram],
                                activeProgramId: legacyProgram.id,
                                history: data.history || []
                            };
                            
                            setDoc(docRef, newData).then(() => {
                                setAppData(newData);
                                setLoading(false);
                            });
                            return; // Exit early to avoid processing old data structure
                        }

                        if (data.history) {
                            data.history.forEach(item => {
                                if (item.date && typeof item.date.toDate === 'function') {
                                    item.date = item.date.toDate();
                                }
                            });
                        }
                        setAppData(data);
                    } else {
                        const defaultProgram = createDefaultProgram();
                        const initialData = {
                            programs: [defaultProgram],
                            activeProgramId: defaultProgram.id,
                            history: []
                        };
                        setDoc(docRef, initialData).then(() => setAppData(initialData));
                    }
                    setLoading(false);
                }, (err) => {
                    console.error("Firestore Snapshot Error:", err);
                    setError("Failed to sync data from the database.");
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user, firebase.db]);

            const updateFirestore = async (newAppData) => {
                if (!user) return;
                const docRef = doc(firebase.db, `users/${user.uid}/workoutData`, "data");
                await setDoc(docRef, newAppData);
            };

            const handleProgramUpdate = (newPrograms) => {
                const newAppData = { ...appData, programs: newPrograms };
                updateFirestore(newAppData);
            };

            const setActiveProgram = (programId) => {
                const newAppData = { ...appData, activeProgramId: programId };
                updateFirestore(newAppData);
            };

            const activeProgram = appData?.programs.find(p => p.id === appData.activeProgramId);

            if (loading) return <div className="flex justify-center items-center h-screen"><div className="text-xl text-gray-500">Loading...</div></div>;
            if (!user) return <AuthPage auth={firebase.auth} />;
            if (error) return <div className="flex justify-center items-center h-screen"><div className="text-xl text-red-500 bg-red-100 p-8 rounded-lg">{error}</div></div>;
            if (!appData || !activeProgram) return <div className="flex justify-center items-center h-screen"><div className="text-xl text-gray-500">Initializing Your Data...</div></div>;
            
            const handleSignOut = async () => {
                await signOut(firebase.auth);
                setAppData(null);
                setCurrentPage('home');
            };

            const renderContent = () => {
                switch (currentPage) {
                    case 'programs':
                        return <ProgramsListPage programs={appData.programs} activeProgramId={appData.activeProgramId} onUpdate={handleProgramUpdate} onSetActive={setActiveProgram} navigateTo={navigateTo} />;
                    // Add more cases for editing specific programs/workouts later
                    default:
                        return <HomePage program={activeProgram} onSignOut={handleSignOut} navigateTo={navigateTo} />;
                }
            };

            return (
                <div className="min-h-screen text-gray-800 p-4 sm:p-8">
                    <div className="max-w-3xl mx-auto py-8">
                        {renderContent()}
                    </div>
                </div>
            );
        }
        
        // --- Page Components ---
        const HomePage = ({ program, onSignOut, navigateTo }) => {
            const currentWorkout = program.workouts[program.currentWorkoutIndex || 0];
            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <div>
                            <h2 className="text-3xl font-bold text-gray-800">Welcome!</h2>
                            <p className="text-gray-600">Active Program: <strong>{program.name}</strong></p>
                        </div>
                        <button onClick={onSignOut} className="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">Sign Out</button>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-md space-y-4">
                        <p className="text-lg text-center">Your next workout is <strong>{currentWorkout.name}</strong>.</p>
                        <button onClick={() => alert("Start workout not implemented yet")} className="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition-colors">
                            Start Workout
                        </button>
                    </div>
                    <div className="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                        <button onClick={() => navigateTo('programs')} className="w-full bg-gray-200 text-gray-800 font-semibold py-3 px-6 rounded-lg hover:bg-gray-300 transition-colors">Manage Programs</button>
                        <button onClick={() => alert("History not implemented yet")} className="w-full bg-gray-200 text-gray-800 font-semibold py-3 px-6 rounded-lg hover:bg-gray-300 transition-colors">View History</button>
                    </div>
                    <p className="text-sm text-center text-gray-500">Data is synced to the cloud in real-time.</p>
                </div>
            );
        };

        const ProgramsListPage = ({ programs, activeProgramId, onUpdate, onSetActive, navigateTo }) => {
            const [editingProgram, setEditingProgram] = useState(null);

            const handleCreateProgram = () => {
                const newProgramName = prompt("Enter new program name:");
                if (newProgramName) {
                    const newProgram = {
                        id: `program_${Date.now()}`,
                        name: newProgramName,
                        workouts: [],
                        currentWorkoutIndex: 0
                    };
                    onUpdate([...programs, newProgram]);
                }
            };
            
            if (editingProgram) {
                return <ProgramEditPage 
                            program={editingProgram} 
                            onSave={(updatedProgram) => {
                                onUpdate(programs.map(p => p.id === updatedProgram.id ? updatedProgram : p));
                                setEditingProgram(null);
                            }}
                            onCancel={() => setEditingProgram(null)}
                        />
            }

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-3xl font-bold text-gray-800">Manage Programs</h2>
                        <button onClick={() => navigateTo('home')} className="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Back to Home</button>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-md space-y-4">
                        {programs.map(program => (
                            <div key={program.id} className="flex items-center justify-between p-4 rounded-lg bg-gray-50">
                                <div>
                                    <p className="font-semibold text-lg">{program.name}</p>
                                    <p className="text-sm text-gray-500">{program.workouts.length} workouts</p>
                                </div>
                                <div className="flex items-center space-x-2">
                                    {program.id !== activeProgramId && (
                                        <button onClick={() => onSetActive(program.id)} className="bg-green-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-green-600 text-sm">Set Active</button>
                                    )}
                                    <button onClick={() => setEditingProgram(program)} className="bg-blue-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-blue-600 text-sm">Edit</button>
                                    <button onClick={() => {
                                        if (confirm(`Are you sure you want to delete "${program.name}"?`)) {
                                            if (program.id === activeProgramId) {
                                                alert("You cannot delete the active program.");
                                                return;
                                            }
                                            onUpdate(programs.filter(p => p.id !== program.id));
                                        }
                                    }} className="bg-red-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-red-600 text-sm">Delete</button>
                                </div>
                            </div>
                        ))}
                    </div>
                    <button onClick={handleCreateProgram} className="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700">Create New Program</button>
                </div>
            );
        };

        const ProgramEditPage = ({ program, onSave, onCancel }) => {
            const [localProgram, setLocalProgram] = useState(JSON.parse(JSON.stringify(program)));
            const dragItem = useRef();
            const dragOverItem = useRef();

            const handleDragStart = (e, position) => {
                dragItem.current = position;
                e.target.classList.add('dragging');
            };

            const handleDragEnter = (e, position) => {
                dragOverItem.current = position;
            };

            const handleDrop = (e) => {
                e.target.closest('.exercise-item').classList.remove('dragging');
                const copyListItems = [...localProgram.workouts];
                const dragItemContent = copyListItems[dragItem.current];
                copyListItems.splice(dragItem.current, 1);
                copyListItems.splice(dragOverItem.current, 0, dragItemContent);
                dragItem.current = null;
                dragOverItem.current = null;
                setLocalProgram({...localProgram, workouts: copyListItems });
            };

            const handleAddWorkout = () => {
                const workoutName = prompt("Enter new workout name:");
                if(workoutName) {
                    const newWorkout = {
                        id: `workout_${Date.now()}`,
                        name: workoutName,
                        exercises: []
                    };
                    setLocalProgram({...localProgram, workouts: [...localProgram.workouts, newWorkout]});
                }
            };
            
            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <input 
                            type="text" 
                            value={localProgram.name} 
                            onChange={(e) => setLocalProgram({...localProgram, name: e.target.value})}
                            className="text-3xl font-bold text-gray-800 p-1 -m-1 rounded bg-transparent"
                        />
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-md space-y-4">
                        {localProgram.workouts.map((workout, index) => (
                            <div 
                                key={workout.id} 
                                className="p-4 rounded-lg bg-gray-50 exercise-item"
                                draggable
                                onDragStart={(e) => handleDragStart(e, index)}
                                onDragEnter={(e) => handleDragEnter(e, index)}
                                onDragEnd={handleDrop}
                                onDragOver={(e) => e.preventDefault()}
                            >
                                <p className="font-semibold">{workout.name}</p>
                                <p className="text-sm text-gray-500">{workout.exercises.length} exercises</p>
                                {/* Add edit/delete for workouts here later */}
                            </div>
                        ))}
                         <button onClick={handleAddWorkout} className="w-full bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600">Add Workout</button>
                    </div>
                    <div className="flex space-x-2">
                         <button onClick={() => onSave(localProgram)} className="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700">Save Changes</button>
                         <button onClick={onCancel} className="w-full bg-gray-200 text-gray-800 font-semibold py-3 px-6 rounded-lg hover:bg-gray-300">Cancel</button>
                    </div>
                </div>
            )
        };


        // --- Render the App ---
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
